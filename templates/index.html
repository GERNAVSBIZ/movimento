<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Tráfego Aéreo com Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; height: 250px; }
        #toast { transition: opacity 0.5s, transform 0.5s; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
        <header class="flex flex-wrap items-center justify-between mb-6 gap-4">
            <h1 class="text-3xl font-bold text-gray-700 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 mr-3 text-blue-600"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 1 4 2 2h3l1-1-2-3 2-2 7 7-1.5 1.5.5 3c.1.5.6.9 1.1.8l.5-.2c.4-.3.6-.7.5-1.2Z"/></svg>
                Análise de Tráfego Aéreo (Firebase)
            </h1>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Coluna da Esquerda -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <!-- NOVO: Gerenciador de Arquivos -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Gerenciador de Arquivos</h2>
                    <div class="space-y-2 pb-4 border-b">
                        <label class="block text-sm font-medium text-gray-700">Enviar novo arquivo .dat</label>
                        <input class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" type="file" id="dataFile" accept=".dat,.dta">
                        <button id="uploadButton" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg mt-2 hover:bg-blue-700 transition duration-300 disabled:bg-gray-400">
                            Enviar e Salvar
                        </button>
                    </div>
                    <div class="space-y-2 pt-4">
                        <label for="fileList" class="block text-sm font-medium text-gray-700">Selecionar arquivo para análise</label>
                        <select id="fileList" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></select>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Filtros de Pesquisa</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="startDate" class="block text-sm font-medium">Data Inicial</label>
                            <input type="date" id="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="endDate" class="block text-sm font-medium">Data Final</label>
                            <input type="date" id="endDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="filterValue" class="block text-sm font-medium">Matrícula, Destino ou Aeronave</label>
                            <input type="text" id="filterValue" placeholder="Ex: AZU2878, SBCF, E295S" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                         <div class="flex space-x-2">
                             <button id="filterButton" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Carregar & Filtrar Dados</button>
                             <button id="clearFilterButton" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Limpar</button>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Coluna da Direita -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Estatísticas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="chart-container"><canvas id="ruleChart"></canvas></div>
                        <div class="chart-container"><canvas id="destChart"></canvas></div>
                        <div class="md:col-span-2 chart-container" style="height: 300px;"><canvas id="hourlyChart"></canvas></div>
                        <div class="md:col-span-2 mt-4 pt-4 border-t space-y-2 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-gray-600">Total de Voos no Período:</span>
                                <span id="total-voos" class="font-bold text-lg text-blue-600">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-gray-600">Operador do Mês (Hora de Pico):</span>
                                <span id="pico-operador" class="font-bold text-lg text-green-600">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md relative">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-xl font-semibold">Registros de Voo</h2>
                        <button id="downloadCsvButton" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 text-sm">Download CSV</button>
                    </div>
                    <div id="table-container" class="overflow-auto" style="max-height: 500px;">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3">Data/Hora (UTC)</th>
                                    <th class="px-4 py-3">Matrícula</th>
                                    <th class="px-4 py-3">Aeronave</th>
                                    <th class="px-4 py-3">Destino</th>
                                    <th class="px-4 py-3">Regra</th>
                                    <th class="px-4 py-3">Pista</th>
                                    <th class="px-4 py-3">Operador</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <tr><td colspan="7" class="text-center p-8">Selecione um arquivo para visualizar os dados.</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="table-overlay" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden rounded-b-xl">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md opacity-0 transform -translate-y-5">
        <p id="toast-message"></p>
    </div>

    <script type="module">
        let currentFlightData = [];
        let ruleChart, destChart, hourlyChart;

        const showLoader = (show) => document.getElementById('table-overlay').classList.toggle('hidden', !show);

        const showToast = (message, isError = false) => {
            const toast = document.getElementById('toast-message');
            const toastContainer = document.getElementById('toast');
            toast.textContent = message;
            toastContainer.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toastContainer.classList.remove('opacity-0', '-translate-y-5');
            setTimeout(() => toastContainer.classList.add('opacity-0', '-translate-y-5'), 3000);
        };

        const populateFileList = async () => {
            const fileListSelect = document.getElementById('fileList');
            fileListSelect.innerHTML = '<option value="">Carregando arquivos...</option>';
            try {
                const response = await fetch('/api/get-files');
                const files = await response.json();
                if (files.error) throw new Error(files.error);

                fileListSelect.innerHTML = '<option value="">Selecione um arquivo</option>';
                files.forEach(file => {
                    const date = new Date(file.data.uploadTimestamp).toLocaleDateString('pt-BR');
                    const option = new Option(`${file.data.fileName} (${date})`, file.id);
                    fileListSelect.add(option);
                });
            } catch (error) {
                console.error(error);
                fileListSelect.innerHTML = '<option value="">Erro ao carregar arquivos</option>';
                showToast('Não foi possível carregar a lista de arquivos.', true);
            }
        };
        
        const fetchAndRenderData = async () => {
            const fileId = document.getElementById('fileList').value;
            if (!fileId) {
                showToast("Por favor, selecione um arquivo da lista para carregar.", true);
                return;
            }

            showLoader(true);
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const filterValue = document.getElementById('filterValue').value;
            
            const params = new URLSearchParams({ fileId, startDate, endDate, filterValue });
            
            try {
                const response = await fetch(`/api/flights?${params.toString()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if(data.error) throw new Error(data.error);
                
                currentFlightData = data;
                renderTable(data);
                renderChartsAndStats(data);
            } catch (error) {
                console.error("Erro ao buscar dados:", error);
                showToast("Erro ao carregar dados do arquivo selecionado.", true);
                renderTable([]);
                renderChartsAndStats([]);
            } finally {
                showLoader(false);
            }
        };

        const renderTable = (data) => {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-8">Nenhum registro encontrado para os filtros aplicados.</td></tr>';
                return;
            }
            data.forEach(flight => {
                const formattedDate = flight.timestamp
                    ? new Date(flight.timestamp).toLocaleString('pt-BR', { timeZone: 'UTC', dateStyle: 'short', timeStyle: 'short' })
                    : '<span class="text-red-500">Inválido</span>';
                
                tableBody.innerHTML += `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-4 py-3">${formattedDate}</td>
                        <td class="px-4 py-3">${flight.matricula || 'N/A'}</td>
                        <td class="px-4 py-3">${flight.tipo_aeronave || 'N/A'}</td>
                        <td class="px-4 py-3">${flight.destino || 'N/A'}</td>
                        <td class="px-4 py-3">${flight.regra_voo || 'N/A'}</td>
                        <td class="px-4 py-3">${flight.pista || ''}</td>
                        <td class="px-4 py-3">${flight.responsavel || 'N/A'}</td>
                    </tr>`;
            });
        };

        const renderChartsAndStats = (data) => {
            document.getElementById('total-voos').textContent = data.length;

            const ruleCounts = data.reduce((acc, f) => { acc[f.regra_voo] = (acc[f.regra_voo] || 0) + 1; return acc; }, {});
            const destCounts = data.reduce((acc, f) => { if (f.destino && f.destino !== 'N/A') acc[f.destino] = (acc[f.destino] || 0) + 1; return acc; }, {});
            const sortedDests = Object.entries(destCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            const hourlyCounts = Array(24).fill(0);
            const peakHourFlights = {};
            data.forEach(f => {
                if (f.timestamp) {
                    const hour = new Date(f.timestamp).getUTCHours();
                    hourlyCounts[hour]++;
                    if (!peakHourFlights[hour]) peakHourFlights[hour] = [];
                    peakHourFlights[hour].push(f);
                }
            });

            let maxFlights = 0, peakHour = -1;
            hourlyCounts.forEach((c, h) => { if(c > maxFlights) { maxFlights = c; peakHour = h; }});

            let peakOperator = '-';
            if(peakHour !== -1 && peakHourFlights[peakHour]) {
                 const opCounts = peakHourFlights[peakHour].reduce((acc, f) => { acc[f.responsavel] = (acc[f.responsavel] || 0) + 1; return acc; }, {});
                 peakOperator = Object.keys(opCounts).reduce((a, b) => opCounts[a] > opCounts[b] ? a : b, '-');
            }
            document.getElementById('pico-operador').textContent = peakOperator;

            if (ruleChart) ruleChart.destroy();
            ruleChart = new Chart('ruleChart', {
                type: 'doughnut', data: { labels: Object.keys(ruleCounts), datasets: [{ data: Object.values(ruleCounts), backgroundColor: ['#3b82f6', '#16a34a', '#ef4444'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Voos por Regra' } } }
            });

            if (destChart) destChart.destroy();
            destChart = new Chart('destChart', {
                type: 'bar', data: { labels: sortedDests.map(d => d[0]), datasets: [{ label: 'Voos', data: sortedDests.map(d => d[1]), backgroundColor: '#8b5cf6' }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { title: { display: true, text: 'Top 5 Destinos' } } }
            });

            if (hourlyChart) hourlyChart.destroy();
            hourlyChart = new Chart('hourlyChart', {
                type: 'line', data: { labels: Array.from({length: 24}, (_, i) => `${i}h`), datasets: [{ label: 'Voos', data: hourlyCounts, borderColor: '#10b981', tension: 0.1, fill: false }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Movimento por Hora (UTC)' } } }
            });
        };

        const handleUpload = async () => {
            const fileInput = document.getElementById('dataFile');
            if (fileInput.files.length === 0) return showToast("Por favor, selecione um arquivo.", true);
            
            const formData = new FormData();
            formData.append('dataFile', fileInput.files[0]);

            const uploadButton = document.getElementById('uploadButton');
            uploadButton.disabled = true;
            uploadButton.textContent = 'Enviando...';

            try {
                const response = await fetch('/api/upload', { method: 'POST', body: formData });
                const result = await response.json();
                if (!response.ok || result.error) throw new Error(result.error || 'Erro no servidor');
                
                showToast(result.success);
                fileInput.value = '';
                await populateFileList();
            } catch (error) {
                console.error("Erro no upload:", error);
                showToast(error.message, true);
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = 'Enviar e Salvar';
            }
        };

        const exportToCsv = () => {
            if (currentFlightData.length === 0) return showToast("Não há dados para exportar.", true);
            const headers = "timestamp_utc,matricula,tipo_aeronave,destino,regra_voo,pista,responsavel";
            const rows = currentFlightData.map(f => [
                f.timestamp ? new Date(f.timestamp).toISOString() : '', `"${f.matricula}"`, `"${f.tipo_aeronave}"`, `"${f.destino}"`, `"${f.regra_voo}"`, f.pista, `"${f.responsavel}"`
            ].join(','));
            const csv = `${headers}\n${rows.join('\n')}`;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `export_voos_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', populateFileList);
        document.getElementById('uploadButton').addEventListener('click', handleUpload);
        document.getElementById('filterButton').addEventListener('click', fetchAndRenderData);
        document.getElementById('clearFilterButton').addEventListener('click', () => {
            document.getElementById('startDate').value = ''; 
            document.getElementById('endDate').value = ''; 
            document.getElementById('filterValue').value = '';
            if (document.getElementById('fileList').value) {
                fetchAndRenderData();
            }
        });
        document.getElementById('downloadCsvButton').addEventListener('click', exportToCsv);
    </script>
</body>
</html>

