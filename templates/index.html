<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Movimento Aeronáutico - Sistema Avançado</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- ✅ LINHA CORRIGIDA/ADICIONADA ABAIXO -->
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        /* ... seu CSS ... */
    </style>
</head>

<body>
    <!-- ... (toda a sua estrutura HTML do <body> permanece a mesma) ... -->

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // --- APPLICATION STATE ---
        let allFlightData = [];
        let flightsByRuleChart, flightsByDestChart, hourlyFlightsChart;

        // --- UI ELEMENTS ---
        const uploadForm = document.getElementById('uploadForm');
        const dataFile = document.getElementById('dataFile');
        const uploadButton = document.getElementById('uploadButton');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const tableBody = document.getElementById('dataTableBody');
        const filterInputs = document.querySelectorAll('.filter-input');
        const clearFilterButton = document.getElementById('clearFilterButton');
        const downloadCsvButton = document.getElementById('downloadCsvButton');

        // --- FIREBASE INTEGRATION LOGIC ---

        /**
         * Busca todos os dados do Firestore através do backend.
         */
        async function fetchFromFirebase() {
            console.log("Buscando dados do Firebase...");
            toggleLoading(true, "Carregando Dados...");
            try {
                const response = await fetch('/api/data');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Falha ao buscar dados do Firebase');
                }
                const data = await response.json();
                allFlightData = data;
                allFlightData.sort((a, b) => {
                    // Garante que registros sem timestamp fiquem no final
                    if (!a.timestamp) return 1;
                    if (!b.timestamp) return -1;
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });
                
                applyFiltersAndRender();
                updateStatus();
                showToast(`${data.length} registros carregados do banco de dados.`, 'success');

            } catch (error) {
                console.error('Erro ao buscar dados do Firebase:', error);
                showToast(error.message, 'error');
                allFlightData = []; // Limpa os dados em caso de erro
                applyFiltersAndRender();
                updateStatus();
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * Lida com o upload do arquivo, que agora salva os dados no Firebase.
         */
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (dataFile.files.length === 0) {
                showToast('Por favor, selecione um arquivo.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('dataFile', dataFile.files[0]);

            toggleLoading(true, "Enviando para DB...");

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro no servidor ao salvar dados.');
                }
                
                showToast(result.message, 'success');
                // Após o sucesso do upload, busca todos os dados novamente para atualizar a interface
                await fetchFromFirebase();

            } catch (error) {
                console.error('Erro no upload:', error);
                showToast(error.message, 'error');
            } finally {
                toggleLoading(false);
                dataFile.value = ''; // Limpa o campo de arquivo
            }
        });
        
        // --- FILTERING AND RENDERING LOGIC (renderChartsAndFilters) ---
        // (Nenhuma alteração necessária aqui, as funções de renderização já trabalham com a variável `allFlightData`)
        function applyFiltersAndRender() {
            // ... (código original sem alterações)
        }

        // --- RENDERING FUNCTIONS ---
        // (Nenhuma alteração necessária aqui)
        function renderTable(data) {
            // ... (código original sem alterações)
        }
        function renderStats(data) {
            // ... (código original sem alterações)
        }
        function renderCharts(data) {
            // ... (código original sem alterações)
        }
        function renderRuleAndDestCharts(data) {
            // ... (código original sem alterações)
        }
        function renderHourlyChart(data) {
            // ... (código original sem alterações)
        }

        // --- UTILITY FUNCTIONS ---
        function toggleLoading(isLoading, text = 'Processar Arquivo') {
            uploadButton.disabled = isLoading;
            buttonText.textContent = isLoading ? text : 'Processar Arquivo';
            loadingSpinner.classList.toggle('hidden', !isLoading);
        }
        
        // ... (Restante das funções utilitárias: showToast, updateStatus, animateNumber, downloadCsvButton listener)
        // ... (permanecem as mesmas)

        // --- INITIALIZATION ---
        // Ao carregar a página, busca os dados existentes no Firebase.
        document.addEventListener('DOMContentLoaded', () => {
            fetchFromFirebase();
            updateStatus();
        });

    </script>
</body>
</html>
